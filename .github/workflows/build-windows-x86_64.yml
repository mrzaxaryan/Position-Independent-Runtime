name: Windows x86_64

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LLVM_VERSION: "21.1.0"

jobs:
  build-and-test:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: C:\Program Files\LLVM
          key: llvm-${{ env.LLVM_VERSION }}-windows-2022

      - name: Install Ninja
        shell: pwsh
        run: |
          choco install ninja -y
          ninja --version

      - name: Install LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ env.LLVM_VERSION }}"
          $exe = "LLVM-$ver-win64.exe"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$ver/$exe"

          Write-Host "Downloading LLVM $ver..."
          Invoke-WebRequest -Uri $url -OutFile $exe
          Start-Process -FilePath ".\$exe" -ArgumentList "/S" -Wait

      - name: Add LLVM to PATH
        shell: pwsh
        run: |
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Build -O0
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=O0"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -O0
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-O0
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -O0 exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -O0 pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build -O1
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=O1"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -O1
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-O1
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -O1 exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -O1 pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build -O2
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=O2"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -O2
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-O2
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -O2 exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -O2 pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build -O3
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=O3"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -O3
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-O3
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -O3 exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -O3 pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build -Os
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=Os"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -Os
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-Os
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -Os exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -Os pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build -Oz
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=Oz"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -Oz
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-Oz
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -Oz exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -Oz pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build -Og
        if: always()
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          cmake --preset windows-x86_64-release "-DOPTIMIZATION_LEVEL=Og"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          cmake --build --preset windows-x86_64-release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload Artifacts -Og
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x86_64-Og
          retention-days: 1
          path: |
            build/
            !build/**/cmake/

      - name: Test -Og exe
        if: always()
        shell: pwsh
        run: |
          & (Get-ChildItem -Path build -Recurse -Filter "output.exe" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Test -Og pic
        if: always()
        shell: pwsh
        run: |
          python scripts/loader.py --arch x86_64 (Get-ChildItem -Path build -Recurse -Filter "output.bin" | Select-Object -First 1).FullName
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
